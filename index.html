
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <title>üçï Sling Fwing ‚Äì Pizza + Sourdough Bread Calculator</title>

  <style>
    body{
      font-family:'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background:#fafafa;
      margin:0;
      padding:16px;
    }
    h1{ font-size:1.6em; margin:0 0 6px 0; }
    h2{ margin:0 0 10px 0; font-size:1.15em; }
    .sub{ color:#555; margin:0 0 14px 0; }
    .card{
      background:#fff;
      padding:14px;
      margin-bottom:14px;
      border-radius:10px;
      box-shadow:0 1px 4px rgba(0,0,0,0.08);
    }
    label{ display:block; margin-top:10px; font-weight:600; }
    input, select{
      width:100%;
      padding:10px;
      margin-top:6px;
      font-size:1em;
      border:1px solid #ddd;
      border-radius:8px;
      box-sizing:border-box;
    }
    .row{
      display:flex;
      gap:10px;
      align-items:center;
      margin-top:6px;
    }
    .row input, .row select{ margin-top:0; }
    .tiny{ width:90px; }
    .mid{ width:170px; }
    .colon{ font-weight:800; padding:0 2px; }
    .output{
      margin-top:10px;
      font-size:1.05em;
      line-height:1.45;
    }
    .bigout{
      margin-top:12px;
      padding:12px;
      border-radius:10px;
      background:#f3f4f6;
      font-size:1.25em;
      font-weight:800;
      line-height:1.25;
    }
    .hint{ color:#666; font-size:0.92em; margin-top:8px; }
    small{ color:#6b7280; }

    .warn{
      margin-top:10px;
      padding:10px;
      border-radius:10px;
      background:#fff7ed;
      border:1px solid #fed7aa;
      color:#7c2d12;
      font-size:0.95em;
      line-height:1.35;
    }
    .ok{
      margin-top:10px;
      padding:10px;
      border-radius:10px;
      background:#f0fdf4;
      border:1px solid #bbf7d0;
      color:#14532d;
      font-size:0.95em;
      line-height:1.35;
    }
    .pill{
      display:inline-block;
      padding:4px 8px;
      border-radius:999px;
      background:#e5e7eb;
      font-size:0.85em;
      font-weight:700;
      margin-right:6px;
    }
    .muted{ color:#6b7280; }
    .hidden{ display:none !important; }

    .tabs{
      display:flex;
      gap:10px;
      margin:0 0 14px 0;
    }
    .tabbtn{
      flex:1;
      border:1px solid #ddd;
      background:#fff;
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:800;
      box-shadow:0 1px 3px rgba(0,0,0,0.06);
    }
    .tabbtn.active{
      border-color:#111827;
      box-shadow:0 2px 10px rgba(0,0,0,0.08);
    }
    .tabpane{ display:none; }
    .tabpane.active{ display:block; }
  </style>
</head>

<body>
  <h1>üçï Sling Fwing ‚Äì Pizza + Sourdough Bread Calculator</h1>
  <p class="sub">
    Levain % = <b>levain total weight</b> as % of total flour (assumes <b>100% hydration levain</b>).<br>
    Pizza tab = paddock-friendly same-day. Bread tab = mixed flours + fridge toggle.
  </p>

  <div class="tabs">
    <button type="button" class="tabbtn active" data-tab="pizza">Pizza Party</button>
    <button type="button" class="tabbtn" data-tab="bread">Sourdough Bread</button>
  </div>

  <!-- =========================
       PIZZA TAB
  ========================== -->
  <div id="tab-pizza" class="tabpane active">

    <div class="card">
      <h2>Pizza Dough Inputs</h2>

      <label>Oven size</label>
      <select id="oven">
        <option value="small" selected>Small Ooni (12") ‚Äî realistic 10.5‚Äì11" pizza</option>
        <option value="large">Large Ooni (16") ‚Äî realistic 13.5‚Äì14.5" pizza</option>
      </select>
      <div class="hint" id="ovenHint">‚Äî</div>

      <label>Number of pizzas desired</label>
      <input id="pizzas" type="number" value="50" min="1" step="1">

      <label>Dough weight per pizza (g)</label>
      <input id="doughWeight" type="number" value="200" min="100" step="5">
      <div class="hint">Rule of thumb: <b>Small Ooni 190‚Äì200g</b> ¬∑ <b>Large Ooni 260‚Äì270g</b></div>

      <label>Dough hydration (%) ‚Äî 58‚Äì62% paddock-friendly</label>
      <input id="hydration" type="number" value="60" min="45" max="85" step="0.5">

      <label>Salt (%) ‚Äî usually 2.3% to 2.7%</label>
      <input id="saltPct" type="number" value="2.5" min="0" max="4" step="0.1">

      <label>Levain (%) to flour ratio ‚Äî Same-day pizza often 2‚Äì4%</label>
      <input id="levainPct" type="number" value="3" min="0" max="60" step="0.5">

      <label>Flour split: Type 00 % of total flour (High Grade is the rest)</label>
      <input id="type00Pct" type="number" value="70" min="0" max="100" step="1">

      <label>Air Temperature where dough will sit (¬∞C)</label>
      <input id="doughTemp" type="number" value="24" step="0.5">

      <p class="hint">
        Note: Levain flour is assumed High Grade. If Type 00 is 100% and levain % &gt; 0, you still need High Grade for the levain.
      </p>
    </div>

    <div class="card">
      <h2>Pizza Dough Quantities</h2>
      <div class="output" id="doughOut">‚Äî</div>
    </div>

    <div class="card">
      <h2>Margherita Baseline (Sauce + Cheese)</h2>

      <label>Pizza build style</label>
      <select id="buildStyle">
        <option value="hand" selected>Hand-stretched (paddock realistic, rimmed)</option>
        <option value="rolled">Rolled / sheeted (home-oven even thickness)</option>
      </select>
      <div class="hint" id="buildHint">‚Äî</div>

      <label>Sauce coverage</label>
      <select id="sauceStyle">
        <option value="light">Light</option>
        <option value="medium" selected>Medium</option>
        <option value="heavy">Heavy</option>
      </select>

      <label>Cheese coverage</label>
      <select id="cheeseStyle">
        <option value="light" selected>Light</option>
        <option value="medium">Medium</option>
        <option value="heavy">Heavy</option>
      </select>

      <label>Tomato can size (g)</label>
      <select id="canSize">
        <option value="400">400 g</option>
        <option value="425" selected>425 g</option>
        <option value="800">800 g</option>
      </select>

      <div class="output" id="margOut">‚Äî</div>
    </div>

    <div class="card">
      <h2>When to Start & Ideal Firing Window</h2>

      <label>Dough process starts at (Autolyse starts here: flour + water only)</label>
      <div class="row">
        <input id="mixHour" class="tiny" type="number" min="1" max="12" value="11">
        <span class="colon">:</span>
        <input id="mixMin" class="tiny" type="number" min="0" max="59" value="30">
        <select id="mixAmPm" class="mid">
          <option value="AM" selected>AM</option>
          <option value="PM">PM</option>
        </select>
      </div>

      <div id="fermentOut" class="bigout">‚Äî</div>
      <div class="hint" id="fermentHint"></div>
    </div>

    <div class="card">
      <h2>Pizza Workflow (Same-Day, Paddock-Proof)</h2>

      <label>Autolyse time (minutes) ‚Äî flour + water only</label>
      <input id="autolyseMin" type="number" value="30" min="0" step="5">

      <label>Fold #1 after adding starter+salt (minutes)</label>
      <input id="fold1Min" type="number" value="45" min="15" step="5">

      <label>Fold #2 after Fold #1 (minutes)</label>
      <input id="fold2Min" type="number" value="45" min="15" step="5">

      <label>Relax time after balling (minutes) ‚Äî kills snap-back</label>
      <input id="relaxMin" type="number" value="150" min="60" step="15">

      <div class="output" id="pizzaGuideOut">‚Äî</div>
    </div>

    <div class="card">
      <h2>Starter Planning (Levain Build)</h2>

      <label>Air temperature where starter will sit (¬∞C)</label>
      <input id="starterTemp" type="number" value="22" step="0.5">

      <div class="output" id="starterOut">‚Äî</div>
    </div>

  </div>

  <!-- =========================
       BREAD TAB (FRIDGE TOGGLE)
  ========================== -->
  <div id="tab-bread" class="tabpane">

    <div class="card">
      <h2>Sourdough Bread Inputs</h2>
      <p class="hint">
        Bread mode uses a <b>100% hydration levain</b>. Mixed flours boost flavour; coarse pizza semolina supported.
      </p>

      <label>Fermentation mode</label>
      <select id="breadFermentMode">
        <option value="same" selected>Same day (room temp only)</option>
        <option value="overnight">Overnight fridge</option>
        <option value="longcold">Long cold ferment (advanced)</option>
      </select>

      <div id="breadFridgeBlock" class="hidden">
        <label>Fridge temperature (¬∞C)</label>
        <input id="breadFridgeTemp" type="number" value="4" min="1" max="12" step="0.5">
        <div class="hint">Domestic fridge ‚âà 4¬∞C ¬∑ Commercial ‚âà 2‚Äì3¬∞C ¬∑ Chilly bin ‚âà 6‚Äì8¬∞C</div>
      </div>

      <label>Recommended flour blend presets</label>
      <select id="breadPreset">
        <option value="custom" selected>Custom (manual)</option>
        <option value="everyday">Everyday Strong (80% white, 15% whole wheat, 5% rye)</option>
        <option value="airy">Airy & Mild (90% white, 10% whole wheat)</option>
        <option value="rustic">Rustic Flavour (75% white, 15% whole wheat, 5% rye, 5% spelt)</option>
        <option value="rye">Rye Kick (70% white, 20% whole wheat, 10% rye)</option>
        <option value="spelt">Spelt Softness (80% white, 10% whole wheat, 10% spelt)</option>
        <option value="italian">Italian Rustic (75% white, 15% whole wheat, 5% rye, 5% semolina)</option>
      </select>

      <label>Number of loaves</label>
      <input id="loaves" type="number" value="2" min="1" step="1">

      <label>Dough weight per loaf (g)</label>
      <input id="loafWeight" type="number" value="900" min="300" step="10">

      <label>Hydration (%)</label>
      <input id="breadHydration" type="number" value="75" min="55" max="90" step="0.5">
      <div class="hint" id="breadHydrationHint">‚Äî</div>

      <label>Salt (%)</label>
      <input id="breadSaltPct" type="number" value="2.1" min="0" max="4" step="0.1">

      <label>Levain (%) to flour ratio (100% hydration levain)</label>
      <input id="breadLevainPct" type="number" value="20" min="0" max="60" step="1">

      <label>Levain flour choice</label>
      <select id="breadLevainFlourMode">
        <option value="white" selected>Use WHITE flour in levain (most reliable rise)</option>
        <option value="blend">Match the dough blend in levain (more flavour, slightly less lift)</option>
      </select>
      <div class="hint">Coarse semolina is <b>never</b> used in levain.</div>

      <label>Flour blend (% of total flour)</label>
      <div class="hint">If they don‚Äôt add to 100%, the calculator normalises them.</div>

      <label>White / Bread flour (%)</label>
      <input id="breadWhitePct" type="number" value="80" min="0" max="100" step="1">

      <label>Whole wheat (%)</label>
      <input id="breadWholePct" type="number" value="15" min="0" max="100" step="1">

      <label>Rye (%)</label>
      <input id="breadRyePct" type="number" value="5" min="0" max="100" step="1">

      <label>Spelt (%)</label>
      <input id="breadSpeltPct" type="number" value="0" min="0" max="100" step="1">

      <label>Coarse semolina (%) ‚Äî pizza-launch semolina</label>
      <input id="breadSemolinaPct" type="number" value="0" min="0" max="100" step="1">
      <div class="hint">Best ‚â§8% unless pre-soaked. Adds chew + golden crust, can feel gritty if pushed.</div>

      <label>Autolyse time (minutes)</label>
      <input id="breadAutolyseMin" type="number" value="30" min="0" step="5">

      <label>Room temperature (¬∞C) for same-day schedule hint</label>
      <input id="breadTemp" type="number" value="22" step="0.5">

      <div class="output" id="breadBlendHint">‚Äî</div>
    </div>

    <div class="card">
      <h2>Bread Quantities</h2>
      <div class="output" id="breadOut">‚Äî</div>
    </div>

    <div class="card">
      <h2>Schedule</h2>

      <label>Mix start time</label>
      <div class="row">
        <input id="breadMixHour" class="tiny" type="number" min="1" max="12" value="9">
        <span class="colon">:</span>
        <input id="breadMixMin" class="tiny" type="number" min="0" max="59" value="0">
        <select id="breadMixAmPm" class="mid">
          <option value="AM" selected>AM</option>
          <option value="PM">PM</option>
        </select>
      </div>

      <div id="breadWindowOut" class="bigout">‚Äî</div>
      <div class="output" id="breadScheduleOut">‚Äî</div>
      <div class="hint">Dough is the boss: bubbles + rise + jiggle, not the clock.</div>
    </div>

  </div>

<script>
  // =========================
  // Helpers
  // =========================
  function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

  function toMinutes(h12, m, ampm){
    let h = (h12 % 12);
    if (ampm === "PM") h += 12;
    return h * 60 + m;
  }

  function fmtTime(mins){
    mins = ((mins % 1440) + 1440) % 1440;
    const h24 = Math.floor(mins / 60);
    const m = mins % 60;
    const ampm = h24 >= 12 ? "PM" : "AM";
    const h12 = (h24 % 12) === 0 ? 12 : (h24 % 12);
    return `${h12}:${String(m).padStart(2,"0")} ${ampm}`;
  }

  function coverageMultiplier(style){
    if (style === "light") return 0.85;
    if (style === "heavy") return 1.15;
    return 1.00;
  }

  // =========================
  // Tabs
  // =========================
  (function setupTabs(){
    const tabBtns = Array.from(document.querySelectorAll(".tabbtn"));
    const panes = {
      pizza: document.getElementById("tab-pizza"),
      bread: document.getElementById("tab-bread"),
    };

function show(tab){
  tabBtns.forEach(b => b.classList.toggle("active", b.dataset.tab === tab));
  Object.entries(panes).forEach(([k, el]) => el.classList.toggle("active", k === tab));

  // force refresh of outputs on tab switch
  if (tab === "bread") calcBread();
  if (tab === "pizza") calcPizza();
}

    tabBtns.forEach(btn => {
      btn.addEventListener("click", () => show(btn.dataset.tab));
    });

    show("pizza");
  })();

  // =========================
  // Elements ‚Äì PIZZA
  // =========================
  const ovenEl = document.getElementById("oven");
  const ovenHintEl = document.getElementById("ovenHint");

  const pizzasEl = document.getElementById("pizzas");
  const doughWeightEl = document.getElementById("doughWeight");
  const hydrationEl = document.getElementById("hydration");
  const saltPctEl = document.getElementById("saltPct");
  const levainPctEl = document.getElementById("levainPct");
  const type00PctEl = document.getElementById("type00Pct");
  const doughTempEl = document.getElementById("doughTemp");

  const mixHourEl = document.getElementById("mixHour");
  const mixMinEl  = document.getElementById("mixMin");
  const mixAmPmEl = document.getElementById("mixAmPm");

  const autolyseMinEl = document.getElementById("autolyseMin");
  const fold1MinEl = document.getElementById("fold1Min");
  const fold2MinEl = document.getElementById("fold2Min");
  const relaxMinEl = document.getElementById("relaxMin");

  const doughOutEl = document.getElementById("doughOut");
  const fermentOutEl = document.getElementById("fermentOut");
  const fermentHintEl = document.getElementById("fermentHint");
  const pizzaGuideOutEl = document.getElementById("pizzaGuideOut");

  const buildStyleEl = document.getElementById("buildStyle");
  const buildHintEl = document.getElementById("buildHint");
  const sauceStyleEl = document.getElementById("sauceStyle");
  const cheeseStyleEl = document.getElementById("cheeseStyle");
  const canSizeEl = document.getElementById("canSize");
  const margOutEl = document.getElementById("margOut");

  const starterTempEl = document.getElementById("starterTemp");
  const starterOutEl = document.getElementById("starterOut");

  let userTouchedDoughWeight = false;
  doughWeightEl.addEventListener("input", () => { userTouchedDoughWeight = true; });

  // =========================
  // Elements ‚Äì BREAD
  // =========================
  const breadFermentModeEl = document.getElementById("breadFermentMode");
  const breadFridgeBlockEl = document.getElementById("breadFridgeBlock");
  const breadFridgeTempEl = document.getElementById("breadFridgeTemp");

  const breadPresetEl = document.getElementById("breadPreset");
  const loavesEl = document.getElementById("loaves");
  const loafWeightEl = document.getElementById("loafWeight");
  const breadHydrationEl = document.getElementById("breadHydration");
  const breadHydrationHintEl = document.getElementById("breadHydrationHint");
  const breadSaltPctEl = document.getElementById("breadSaltPct");
  const breadLevainPctEl = document.getElementById("breadLevainPct");
  const breadLevainFlourModeEl = document.getElementById("breadLevainFlourMode");

  const breadWhitePctEl = document.getElementById("breadWhitePct");
  const breadWholePctEl = document.getElementById("breadWholePct");
  const breadRyePctEl = document.getElementById("breadRyePct");
  const breadSpeltPctEl = document.getElementById("breadSpeltPct");
  const breadSemolinaPctEl = document.getElementById("breadSemolinaPct");

  const breadAutolyseMinEl = document.getElementById("breadAutolyseMin");
  const breadTempEl = document.getElementById("breadTemp");

  const breadBlendHintEl = document.getElementById("breadBlendHint");
  const breadOutEl = document.getElementById("breadOut");

  const breadMixHourEl = document.getElementById("breadMixHour");
  const breadMixMinEl  = document.getElementById("breadMixMin");
  const breadMixAmPmEl = document.getElementById("breadMixAmPm");

  const breadWindowOutEl = document.getElementById("breadWindowOut");
  const breadScheduleOutEl = document.getElementById("breadScheduleOut");

  function syncBreadFridgeUI(){
    const mode = breadFermentModeEl.value;
    breadFridgeBlockEl.classList.toggle("hidden", mode === "same");
  }

  // =========================
  // PIZZA CALC
  // =========================
  function calcPizza(){
    const oven = ovenEl.value;

    if (oven === "small") {
      ovenHintEl.innerHTML = `<span class="pill">Small Ooni</span> Aim for <b>10.5‚Äì11"</b> pizzas. Suggested dough ball: <b>190‚Äì200g</b>.`;
      if (!userTouchedDoughWeight) doughWeightEl.value = 200;
    } else {
      ovenHintEl.innerHTML = `<span class="pill">Large Ooni</span> Aim for <b>13.5‚Äì14.5"</b> pizzas. Suggested dough ball: <b>260‚Äì270g</b>.`;
      if (!userTouchedDoughWeight) doughWeightEl.value = 265;
    }

    const pizzas = +pizzasEl.value || 0;
    const doughW = +doughWeightEl.value || 0;
    const hydration = (+hydrationEl.value || 0) / 100;
    const saltPct = (+saltPctEl.value || 0) / 100;
    const levainPct = (+levainPctEl.value || 0) / 100;
    const type00Pct = (+type00PctEl.value || 0) / 100;
    const hgPct = 1 - type00Pct;

    const doughTemp = +doughTempEl.value || 24;

    const totalDough = pizzas * doughW;

    // Flour from dough WITHOUT levain in denominator
    const totalFlourAll = totalDough / (1 + hydration + saltPct);

    // Levain 100% hydration
    const levainTotal = totalFlourAll * levainPct;
    const levainFlour = levainTotal / 2;
    const levainWater = levainTotal / 2;

    const waterToAdd = Math.max(0, (totalFlourAll * hydration) - levainWater);
    const salt = totalFlourAll * saltPct;

    // Flour split includes levain flour, but levain is assumed High Grade
    const type00Flour = totalFlourAll * type00Pct;
    const highGradeTotalRequired = totalFlourAll * hgPct;
    const highGradeFlourToAdd = Math.max(0, highGradeTotalRequired - levainFlour);

    const autolyseMin = clamp(+autolyseMinEl.value || 30, 0, 180);

    doughOutEl.innerHTML = `
      <b>ORDER (PIZZA OPTIMISED)</b><br><br>
      <span class="pill">Autolyse</span> Mix <b>Water + Flour only</b> (shaggy), rest <b>${autolyseMin} min</b>.<br><br>

      <b>Water:</b> <b>${waterToAdd.toFixed(0)} g</b><br>
      <b>Type 00 flour:</b> <b>${type00Flour.toFixed(0)} g</b><br>
      <b>High Grade flour:</b> <b>${highGradeFlourToAdd.toFixed(0)} g</b><br><br>

      <span class="pill">After autolyse</span><br>
      <b>Levain (100% hydration):</b> <b>${levainTotal.toFixed(0)} g</b><br>
      <b>Salt:</b> <b>${salt.toFixed(1)} g</b><br><br>

      <small>
        Total dough: ${totalDough.toFixed(0)} g ¬∑ Total flour: ${totalFlourAll.toFixed(0)} g ¬∑
        Hydration: ${(hydration*100).toFixed(1)}% ¬∑ Salt: ${(saltPct*100).toFixed(1)}% ¬∑ Levain: ${(levainPct*100).toFixed(1)}%
      </small>
    `;

    // Sauce + cheese
    const buildStyle = buildStyleEl.value;
    const pizzasN = Math.max(0, pizzas);

    let sauceBase = (oven === "small") ? 60 : 80;
    let cheeseBase = (oven === "small") ? 80 : 110;

    if (buildStyle === "rolled") {
      sauceBase = Math.round(sauceBase * 1.25);
      cheeseBase = Math.round(cheeseBase * 1.15);
      buildHintEl.innerHTML = `<span class="pill">Rolled</span> Even thickness + more centre area ‚Üí estimates bumped.`;
    } else {
      buildHintEl.innerHTML = `<span class="pill">Hand-stretched</span> Rim eats area ‚Üí conservative estimates, less waste.`;
    }

    const saucePer = Math.round(sauceBase * coverageMultiplier(sauceStyleEl.value));
    const cheesePer = Math.round(cheeseBase * coverageMultiplier(cheeseStyleEl.value));

    const sauceTotal = pizzasN * saucePer;
    const cheeseTotal = pizzasN * cheesePer;

    const canSize = +canSizeEl.value || 425;
    const sauceWithBuffer = Math.round(sauceTotal * 1.12);
    const cansNeeded = Math.ceil(sauceWithBuffer / canSize);

    const cheeseWithBuffer = Math.round(cheeseTotal * 1.10);
    const cheeseKg = (cheeseWithBuffer / 1000).toFixed(2);

    margOutEl.innerHTML = `
      <b>Per pizza (Margherita baseline)</b><br>
      <b>Sauce:</b> <b>${saucePer} g</b><br>
      <b>Cheese:</b> <b>${cheesePer} g</b><br><br>

      <b>Total for ${pizzasN} pizzas</b><br>
      <b>Sauce:</b> ${sauceTotal.toFixed(0)} g ‚Üí with buffer: <b>${sauceWithBuffer} g</b> ‚Üí buy <b>${cansNeeded}</b> √ó <b>${canSize} g</b><br>
      <b>Cheese:</b> ${cheeseTotal.toFixed(0)} g ‚Üí with buffer: <b>${cheeseWithBuffer} g</b> ‚Üí buy <b>${cheeseKg} kg</b>
    `;

    // Starter planning (simple)
    const starterTemp = +starterTempEl.value || 22;
    const starterHours = clamp(12 - (starterTemp - 20) * 0.8, 4, 18);
    starterOutEl.innerHTML = `
      <b>Target levain:</b> <b>${levainTotal.toFixed(0)} g</b><br>
      <b>Air temp:</b> <b>${starterTemp.toFixed(1)} ¬∞C</b><br>
      <b>Rough peak time:</b> <b>${starterHours.toFixed(1)} h</b><br>
      <div class="hint">If it‚Äôs flat/sour/collapsed: feed again and wait for peak.</div>
    `;

// =========================
// Firing window (levain-aware) + workflow schedule
// =========================
const mixHour = clamp(+mixHourEl.value || 12, 1, 12);
const mixMin  = clamp(+mixMinEl.value || 0, 0, 59);
const mixAmPm = mixAmPmEl.value || "AM";
const mixAtMins = toMinutes(mixHour, mixMin, mixAmPm);

// Levain-aware timing model
const levainPctNum_F = (+levainPctEl.value || 0);     // percent
const hydrationPct_F = (+hydrationEl.value || 0);     // percent

// Baseline: 3% levain, ~62% hydration, ~24¬∞C ‚Üí ~6h
const levainFactor = Math.pow(Math.max(levainPctNum_F, 0.5) / 3, -0.45);
const tempFactor   = Math.pow(1.18, (24 - doughTemp) / 2);
const hydrationFactor = clamp(1 + (62 - hydrationPct_F) * 0.015, 0.85, 1.25);

let primeStartHours = 6.0 * levainFactor * tempFactor * hydrationFactor;
primeStartHours = clamp(primeStartHours, 2.5, 14);

const windowWidthHours = clamp(2.4 - Math.min(levainPctNum_F, 15) * 0.06, 1.4, 2.4);
const primeEndHours = primeStartHours + windowWidthHours;

const windowStart = mixAtMins + Math.round(primeStartHours * 60);
const windowEnd   = mixAtMins + Math.round(primeEndHours * 60);

fermentOutEl.innerHTML = `<b>${fmtTime(windowStart)} ‚Äì ${fmtTime(windowEnd)}</b> <b>IDEAL FIRING WINDOW</b>`;
fermentHintEl.textContent =
  `Model: levain ${levainPctNum_F.toFixed(1)}% ¬∑ hydration ${hydrationPct_F.toFixed(1)}% ¬∑ temp ${doughTemp.toFixed(1)}¬∞C ‚Üí ~${primeStartHours.toFixed(1)}‚Äì${primeEndHours.toFixed(1)}h`;

    const fold1Min = clamp(+fold1MinEl.value || 45, 15, 240);
    const fold2Min = clamp(+fold2MinEl.value || 45, 15, 240);
    const relaxMin = clamp(+relaxMinEl.value || 150, 60, 360);

    const tAutolyseStart = mixAtMins;
    const tAutolyseEnd = tAutolyseStart + autolyseMin;
    const tFold1 = tAutolyseEnd + fold1Min;
    const tFold2 = tFold1 + fold2Min;

    let tBall = windowStart - relaxMin;
    tBall = Math.max(tBall, tFold2 + 15);
    const tRelaxDone = tBall + relaxMin;

       const levNum = (+levainPctEl.value || 0);
    let levMsg = "";
    if (levNum <= 0) levMsg = `Levain 0% ‚Üí not sourdough.`;
    else if (levNum <= 4) levMsg = `‚úÖ Pizza zone: <b>2‚Äì4%</b> is calm + stretchy.`;
    else if (levNum <= 8) levMsg = `Moderate starter: faster, give balls longer rest.`;
    else levMsg = `‚ö†Ô∏è High starter: can feel tight early, then slack later.`;

    // --- Timing signal (do you have enough rest BEFORE the window starts?) ---
    const restBeforeWindowMin = Math.round(windowStart - tBall); // usually equals relaxMin unless tBall was pushed later
    let timingMsg = "";
    let timingClass = "ok";

    if (restBeforeWindowMin < 45){
      timingClass = "warn";
      timingMsg = `Timing is tight: only <b>${restBeforeWindowMin} min</b> ball rest before the window.`;
    } else if (restBeforeWindowMin < 90){
      timingClass = "warn";
      timingMsg = `Timing is borderline: <b>${restBeforeWindowMin} min</b> ball rest before the window.`;
    } else {
      timingMsg = `Timing looks good: <b>${restBeforeWindowMin} min</b> ball rest before the window.`;
    }

    // --- Snap-back risk signal (mostly relax time, plus small nudges) ---

    let riskScore = 0; // higher = more snap-back risk

    // relax dominates (uses EXISTING relaxMin from above)
    if (relaxMin < 45) riskScore += 3;
    else if (relaxMin < 90) riskScore += 2;
    else if (relaxMin < 120) riskScore += 1;

    // stiffer dough tends to snap back more
    if (hydrationPct <= 58) riskScore += 1;
    if (hydrationPct >= 68) riskScore -= 1;

    // higher levain tends to relax dough more (but can go slack later)
    if (levainPctNum >= 8) riskScore -= 1;
    if (levainPctNum >= 15) riskScore -= 1;

    riskScore = clamp(riskScore, 0, 4);

    let riskLabel = "Low";
    let riskClass = "ok";
    if (riskScore >= 3){ riskLabel = "High"; riskClass = "warn"; }
    else if (riskScore >= 2){ riskLabel = "Medium"; riskClass = "warn"; }

    const statusBox = `
      <div class="${timingClass}">
        <b>${timingMsg}</b><br>
        <span class="muted">Ball at <b>${fmtTime(tBall)}</b> ¬∑ Window starts <b>${fmtTime(windowStart)}</b></span>
      </div>
      <div class="${riskClass}">
        <b>Snap-back risk: ${riskLabel}</b><br>
        <span class="muted">Based on relax ${relaxMin} min, hydration ${hydrationPct}%, levain ${levainPctNum}%.</span>
      </div>
    `;
    
    pizzaGuideOutEl.innerHTML = `
      <span class="pill">Process</span> Water+Flour ‚Üí Autolyse ‚Üí Add levain+salt ‚Üí Fold ‚Üí Fold ‚Üí Ball ‚Üí Relax ‚Üí Bake<br><br>
      ‚Ä¢ <b>${fmtTime(tAutolyseStart)}</b> Autolyse start<br>
      ‚Ä¢ <b>${fmtTime(tAutolyseEnd)}</b> Add levain + salt<br>
      ‚Ä¢ <b>${fmtTime(tFold1)}</b> Fold #1<br>
      ‚Ä¢ <b>${fmtTime(tFold2)}</b> Fold #2<br>
      ‚Ä¢ <b>${fmtTime(tBall)}</b> Ball up<br>
      ‚Ä¢ <b>${fmtTime(tBall)}‚Äì${fmtTime(tRelaxDone)}</b> Relax<br><br>
      <b>Levain guidance:</b> ${levMsg}
      ${statusBox}
    `;
  }

  // =========================
  // BREAD CALC (FRIDGE MODE)
  // =========================
  function calcBread(){
    syncBreadFridgeUI();

    const loaves = +loavesEl.value || 0;
    const loafW = +loafWeightEl.value || 0;

    const baseHydration = (+breadHydrationEl.value || 0) / 100;
    const saltPct = (+breadSaltPctEl.value || 0) / 100;
    const levainPct = (+breadLevainPctEl.value || 0) / 100;
    const levainPctNum = (+breadLevainPctEl.value || 0);
    const autolyseMin = clamp(+breadAutolyseMinEl.value || 30, 0, 180);

    // Normalise blend to 100
    let w  = +breadWhitePctEl.value || 0;
    let ww = +breadWholePctEl.value || 0;
    let rye = +breadRyePctEl.value || 0;
    let sp  = +breadSpeltPctEl.value || 0;
    let sem = +breadSemolinaPctEl.value || 0;

    let sum = w + ww + rye + sp + sem;
    if (sum <= 0) { w = 100; ww = rye = sp = sem = 0; sum = 100; }

    const nw  = w  / sum;
    const nww = ww / sum;
    const nrye = rye / sum;
    const nsp = sp / sum;
    const nsem = sem / sum;

    // Semolina hydration bump (coarse)
    let hydrationAdj = 0;
    if (nsem > 0) hydrationAdj += Math.min(0.04, nsem * 0.5);
    const effectiveHydration = baseHydration + hydrationAdj;

    breadHydrationHintEl.innerHTML =
      hydrationAdj > 0
        ? `Coarse semolina detected ‚Üí auto hydration bump: <b>+${(hydrationAdj*100).toFixed(1)}%</b> (effective: <b>${(effectiveHydration*100).toFixed(1)}%</b>)`
        : `Effective hydration: <b>${(effectiveHydration*100).toFixed(1)}%</b>`;

    const totalDough = loaves * loafW;

    // Flour from dough WITHOUT levain in denominator
    const totalFlourAll = totalDough / (1 + effectiveHydration + saltPct);

    // Levain 100% hydration
    const levainTotal = totalFlourAll * levainPct;
    const levainFlour = levainTotal / 2;
    const levainWater = levainTotal / 2;

    const waterToAdd = Math.max(0, (totalFlourAll * effectiveHydration) - levainWater);
    const salt = totalFlourAll * saltPct;

    // Totals by flour type (includes levain flour)
    const whiteTotal = totalFlourAll * nw;
    const wholeTotal = totalFlourAll * nww;
    const ryeTotal = totalFlourAll * nrye;
    const speltTotal = totalFlourAll * nsp;
    const semolinaTotal = totalFlourAll * nsem;

    // Levain flour allocation (semolina NEVER in levain)
    const levainMode = breadLevainFlourModeEl.value; // white/blend
    let levWhite = levainFlour, levWhole = 0, levRye = 0, levSpelt = 0;

    if (levainMode === "blend") {
      const nonSemSum = nw + nww + nrye + nsp;
      const rw  = nonSemSum > 0 ? (nw / nonSemSum) : 1;
      const rww = nonSemSum > 0 ? (nww / nonSemSum) : 0;
      const rrye= nonSemSum > 0 ? (nrye / nonSemSum) : 0;
      const rsp = nonSemSum > 0 ? (nsp / nonSemSum) : 0;

      levWhite = levainFlour * rw;
      levWhole = levainFlour * rww;
      levRye   = levainFlour * rrye;
      levSpelt = levainFlour * rsp;
    }

    // Flour to add
    const whiteAdd = Math.max(0, whiteTotal - levWhite);
    const wholeAdd = Math.max(0, wholeTotal - levWhole);
    const ryeAdd = Math.max(0, ryeTotal - levRye);
    const speltAdd = Math.max(0, speltTotal - levSpelt);
    const semolinaAdd = Math.max(0, semolinaTotal);

    const wholeGrainPct = (nww + nrye + nsp) * 100;
    const semPct = nsem * 100;

    breadBlendHintEl.innerHTML = `
      <b>Blend check:</b><br>
      White ${(nw*100).toFixed(0)}% ¬∑ Whole ${(nww*100).toFixed(0)}% ¬∑ Rye ${(nrye*100).toFixed(0)}% ¬∑ Spelt ${(nsp*100).toFixed(0)}% ¬∑ Semolina ${(nsem*100).toFixed(0)}%<br>
      <span class="muted">
        ${semPct > 8 ? "‚ö†Ô∏è High semolina: pre-soak recommended. " : ""}
        ${wholeGrainPct <= 25 ? "‚úÖ Nice balance for lift + flavour." : "Higher wholegrain tightens crumb‚Äîwatch bulk."}
      </span>
    `;

    breadOutEl.innerHTML = `
      <b>Totals for ${loaves} loaf/loaves</b><br><br>

      <b>Autolyse (optional):</b> Flour + Water only, rest <b>${autolyseMin} min</b>.<br><br>

      <b>ADD THIS</b><br>
      <b>1) Water to add:</b> <b>${waterToAdd.toFixed(0)} g</b><br><br>

      <b>2) Flour to add:</b><br>
      ‚Ä¢ White: <b>${whiteAdd.toFixed(0)} g</b><br>
      ‚Ä¢ Whole wheat: <b>${wholeAdd.toFixed(0)} g</b><br>
      ‚Ä¢ Rye: <b>${ryeAdd.toFixed(0)} g</b><br>
      ‚Ä¢ Spelt: <b>${speltAdd.toFixed(0)} g</b><br>
      ‚Ä¢ Semolina: <b>${semolinaAdd.toFixed(0)} g</b><br><br>

      <b>3) Levain (100%):</b> <b>${levainTotal.toFixed(0)} g</b><br>
      <b>4) Salt:</b> <b>${salt.toFixed(1)} g</b><br><br>

      <small>
        Total dough: ${(loaves * loafW).toFixed(0)} g ¬∑ Total flour: ${totalFlourAll.toFixed(0)} g ¬∑
        Hydration: ${(baseHydration*100).toFixed(1)}% (effective ${(effectiveHydration*100).toFixed(1)}%) ¬∑
        Salt: ${(saltPct*100).toFixed(1)}% ¬∑ Levain: ${(levainPct*100).toFixed(1)}%
      </small>
    `;

    // Schedule
    const mode = breadFermentModeEl.value;
    const temp = +breadTempEl.value || 22;

    const mixHour = clamp(+breadMixHourEl.value || 12, 1, 12);
    const mixMin  = clamp(+breadMixMinEl.value || 0, 0, 59);
    const mixAmPm = breadMixAmPmEl.value || "AM";
    const startAt = toMinutes(mixHour, mixMin, mixAmPm);

    // Same-day bulk heuristic
    const bulkBase = 4.5 * (20 / Math.max(5, levainPctNum));
    const wholeSpeed = 1 - Math.min(0.18, (wholeGrainPct/100) * 0.25);
    const tempAdj = Math.pow(1.18, (22 - temp) / 2);
    const bulkHours = clamp(bulkBase * wholeSpeed * tempAdj, 2.5, 9.0);

    if (mode === "same"){
      const bulkEnd = startAt + Math.round((autolyseMin/60 + bulkHours) * 60);
      const benchRestMin = 20;
      const finalProofHours = clamp(1.5 * tempAdj, 1.0, 3.0);
      const bakeAt = bulkEnd + benchRestMin + Math.round(finalProofHours * 60);

      breadWindowOutEl.innerHTML = `<b>${fmtTime(bakeAt - 30)} ‚Äì ${fmtTime(bakeAt + 30)}</b> <b>BAKE WINDOW</b>`;
      breadScheduleOutEl.innerHTML = `
        <b>Same-day guide schedule</b><br>
        ‚Ä¢ <b>${fmtTime(startAt)}</b> Start: autolyse (optional) ${autolyseMin} min<br>
        ‚Ä¢ <b>${fmtTime(startAt + autolyseMin)}</b> Add levain + salt, mix to medium development<br>
        ‚Ä¢ <b>${fmtTime(startAt + autolyseMin + 30)}</b> Fold #1 (optional)<br>
        ‚Ä¢ <b>${fmtTime(startAt + autolyseMin + 90)}</b> Fold #2 (optional)<br>
        ‚Ä¢ <b>${fmtTime(bulkEnd)}</b> Shape (aim ~30‚Äì60% rise)<br>
        ‚Ä¢ <b>${fmtTime(bakeAt)}</b> Bake
        <div class="hint">Bulk estimate: ~${bulkHours.toFixed(1)}h at ${temp.toFixed(1)}¬∞C with ${levainPctNum.toFixed(0)}% levain.</div>
      `;
      return;
    }

    // Fridge mode
    const fridgeTemp = clamp(+breadFridgeTempEl.value || 4, 1, 12);

    let benchHours = clamp(bulkHours * 0.35, 1.0, 3.0);
    if (levainPctNum >= 25) benchHours = Math.min(benchHours, 1.5);
    if (levainPctNum >= 35) benchHours = Math.min(benchHours, 1.0);

    const benchEnd = startAt + Math.round((autolyseMin/60 + benchHours) * 60);

    const coldFactor = clamp(4 / fridgeTemp, 0.5, 2.0);

    let coldMin = (mode === "overnight") ? 12 : 18;
    let coldMax = (mode === "overnight") ? 16 : 36;

    coldMin = Math.round(coldMin * coldFactor);
    coldMax = Math.round(coldMax * coldFactor);

    const earliestBake = benchEnd + coldMin * 60;
    const latestBake   = benchEnd + coldMax * 60;

    breadWindowOutEl.innerHTML = `<b>${fmtTime(earliestBake)} ‚Äì ${fmtTime(latestBake)}</b> <b>‚ÄúREADY‚Äù WINDOW</b>`;

    const warn = (levainPctNum > 25)
      ? `<div class="warn"><b>High levain (${levainPctNum.toFixed(0)}%) + fridge:</b> keep bench short; don‚Äôt push the long-cold end.</div>`
      : `<div class="ok"><b>Good fridge setup:</b> this levain % plays nicely with cold fermentation.</div>`;

    breadScheduleOutEl.innerHTML = `
      <b>Fridge plan (${mode === "overnight" ? "Overnight" : "Long cold"})</b><br>
      ‚Ä¢ <b>${fmtTime(startAt)}</b> Start: autolyse (optional) ${autolyseMin} min<br>
      ‚Ä¢ <b>${fmtTime(startAt + autolyseMin)}</b> Add levain + salt, mix to medium development<br>
      ‚Ä¢ <b>${fmtTime(benchEnd)}</b> <b>Into fridge</b> (aim ~20‚Äì40% rise, not full bulk)<br><br>

      <b>Cold ferment @ ${fridgeTemp.toFixed(1)}¬∞C:</b> <b>${coldMin}‚Äì${coldMax} hours</b><br>
      <span class="muted">Colder fridge = slower (can go longer); warmer fridge = faster (go shorter).</span><br><br>

      <b>Tomorrow flow:</b><br>
      ‚Ä¢ Pull from fridge <b>60‚Äì90 min</b> before bake (or shape cool, then proof).<br>
      ‚Ä¢ Bake when airy; poke returns slowly.
      ${warn}
    `;
  }

  // =========================
  // Bread presets
  // =========================
  function applyBreadPreset(){
    const p = breadPresetEl.value;
    if (p === "custom") return;

    const presets = {
      everyday: { w:80, ww:15, rye:5, sp:0, sem:0 },
      airy:     { w:90, ww:10, rye:0, sp:0, sem:0 },
      rustic:   { w:75, ww:15, rye:5, sp:5, sem:0 },
      rye:      { w:70, ww:20, rye:10, sp:0, sem:0 },
      spelt:    { w:80, ww:10, rye:0, sp:10, sem:0 },
      italian:  { w:75, ww:15, rye:5, sp:0, sem:5 },
    };

    const x = presets[p];
    breadWhitePctEl.value = x.w;
    breadWholePctEl.value = x.ww;
    breadRyePctEl.value = x.rye;
    breadSpeltPctEl.value = x.sp;
    breadSemolinaPctEl.value = x.sem;

    calcBread();
  }

  // =========================
  // Wiring
  // =========================
  breadPresetEl.addEventListener("change", applyBreadPreset);
  breadFermentModeEl.addEventListener("change", () => { syncBreadFridgeUI(); calcBread(); });

  document.querySelectorAll("#tab-pizza input, #tab-pizza select").forEach(el => {
    el.addEventListener("input", calcPizza);
    el.addEventListener("change", calcPizza);
  });

  document.querySelectorAll("#tab-bread input, #tab-bread select").forEach(el => {
    el.addEventListener("input", calcBread);
    el.addEventListener("change", calcBread);
  });

  // Initial render
  syncBreadFridgeUI();
  calcPizza();
  calcBread();
</script>

</body>
</html>
